<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1"/>
<title>한빔한복 지점별 광고유입 리포트</title>
<style>
  :root{
    --sky:#38a3ff;
    --text:#0f172a;
    --muted:#64748b;
    --line:#b9ddff;
    --r:16px;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    font-family:"NanumGothicNeo","Nanum Gothic","Apple SD Gothic Neo","Noto Sans KR",system-ui,sans-serif;
    background:#fff;
    color:var(--text);
    -webkit-text-size-adjust:100%;
    text-size-adjust:100%;
  }
  .wrap{
    max-width:820px;
    margin:0 auto;
    padding:14px 14px 24px;
  }
  h1{
    margin:6px 0 12px;
    font-size:18px;
    letter-spacing:-0.02em;
  }

  .panel{
    border:1px solid #e2e8f0;
    border-radius:var(--r);
    background:#fff;
    padding:12px;
    margin-bottom:12px;
  }

  /* ✅ 한 줄 컨트롤: 화면이 좁으면 가로 스크롤로 “한줄 유지” */
  .controls{
    display:flex;
    align-items:flex-end;
    gap:10px;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    padding-bottom:2px;
  }
  .field{
    flex:0 0 auto;
    min-width:160px;
  }
  .field.small{ min-width:140px; }
  .field.date{ min-width:150px; }

  .label{
    font-size:12px;
    color:var(--muted);
    margin:0 0 6px;
    font-weight:900;
  }
  select,input{
    width:100%;
    height:42px;
    border-radius:12px;
    border:1px solid #e2e8f0;
    padding:0 12px;
    font-size:14px;
    outline:none;
    background:#fff;
  }
  select:focus,input:focus{
    border-color:var(--sky);
    box-shadow:0 0 0 3px rgba(56,163,255,0.18);
  }

  .status{
    font-size:12px;
    color:var(--muted);
    font-weight:900;
    margin-top:8px;
  }

  .svgBox{
    border:1px solid #e2e8f0;
    border-radius:14px;
    background:#fff;
    padding:10px;
  }

  .cards{
    display:grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap:10px;
    margin-top:12px;
  }
  .card{
    border:2px solid var(--line);
    border-radius:16px;
    padding:12px;
    min-height:96px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .card .t{
    font-size:12px;
    color:var(--muted);
    font-weight:1000;
  }
  .card .v{
    font-size:26px;
    font-weight:1100;
    letter-spacing:-0.02em;
  }

  @media (min-width:720px){
    h1{ font-size:20px; }
    .cards{ grid-template-columns: repeat(4, minmax(0,1fr)); }
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>한빔한복 지점별 광고유입 리포트</h1>

  <div class="panel">
    <div class="controls">
      <div class="field">
        <div class="label">지점</div>
        <select id="branch">
          <option value="ALL">전체 지점(합산)</option>
        </select>
      </div>

      <div class="field small">
        <div class="label">추이</div>
        <select id="trend">
          <option value="daily">날짜별 추이</option>
          <option value="monthly">월별 추이</option>
        </select>
      </div>

      <div class="field small">
        <div class="label">지표</div>
        <select id="metric">
          <option value="visits">방문(visit)</option>
          <option value="call">전화 클릭</option>
          <option value="reserve">예약 클릭</option>
          <option value="more">더 알아보기</option>
          <option value="kakao_pending">카톡(준비중)</option>
        </select>
      </div>

      <div class="field date">
        <div class="label">시작일</div>
        <input id="start" type="date">
      </div>

      <div class="field date">
        <div class="label">종료일</div>
        <input id="end" type="date">
      </div>
    </div>

    <div class="status" id="status">불러오는 중…</div>
  </div>

  <div class="panel">
    <div class="svgBox" id="chartBox"></div>
    <div class="cards" id="cards"></div>
  </div>
</div>

<script>
/*** ✅ GAS WebApp URL ***/
const API = "https://script.google.com/macros/s/AKfycbzffPcpmzRqRPZQSEWZLHP8iJX2xMvl7Aw6SxkZutPac-kEPNAxSIt1vLqNhn_wxMGI/exec";

/*** ✅ REPORT_TOKEN: GAS Script Properties의 REPORT_TOKEN과 동일해야 함
 *  - 귀찮으면 여기 문자열을 바꾸고, GAS에도 똑같이 넣어.
 */
const REPORT_TOKEN = "hb_report_2026"; // ← 너가 실제로 설정한 값으로 맞춰

const elBranch = document.getElementById('branch');
const elTrend  = document.getElementById('trend');
const elMetric = document.getElementById('metric');
const elStart  = document.getElementById('start');
const elEnd    = document.getElementById('end');
const elStatus = document.getElementById('status');
const elChart  = document.getElementById('chartBox');
const elCards  = document.getElementById('cards');

let lastData = null;
let debounceTimer = null;

function yyyyMmDd(d){
  const pad = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
function setDefaultRange(){
  const end = new Date();
  const start = new Date();
  start.setDate(start.getDate() - 13); // 최근 14일
  elEnd.value = yyyyMmDd(end);
  elStart.value = yyyyMmDd(start);
}
function qs(params){
  return Object.entries(params)
    .map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
    .join('&');
}

/* ✅ JSONP 로드 (CORS 해결) */
function jsonp(url){
  return new Promise((resolve, reject)=>{
    const cb = 'HB_CB_' + Math.random().toString(16).slice(2);
    const s = document.createElement('script');
    const cleanup = ()=>{
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
      if(s && s.parentNode) s.parentNode.removeChild(s);
    };
    window[cb] = (data)=>{
      cleanup();
      resolve(data);
    };
    s.onerror = ()=>{
      cleanup();
      reject(new Error('jsonp_load_failed'));
    };
    s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
    document.body.appendChild(s);
  });
}

async function fetchReport(){
  const branch = elBranch.value || 'ALL';
  const start  = elStart.value;
  const end    = elEnd.value;

  elStatus.textContent = '불러오는 중…';

  const url = `${API}?` + qs({
    mode:'report',
    token: REPORT_TOKEN,
    branch,
    start,
    end
  });

  try{
    const json = await jsonp(url);

    if(!json || !json.ok){
      elStatus.textContent = `조회 실패: ${json?.error || 'unknown'} (토큰/스프레드시트ID 확인)`;
      lastData = null;
      renderEmpty();
      return;
    }

    lastData = json;

    // 지점 리스트 1회 채우기
    if (elBranch.options.length <= 1 && Array.isArray(json.branches)){
      json.branches.forEach(b=>{
        const opt = document.createElement('option');
        opt.value = b;
        opt.textContent = b;
        elBranch.appendChild(opt);
      });
    }

    elStatus.textContent = `${json.start} ~ ${json.end} / ${json.branch === 'ALL' ? '전체 지점(합산)' : json.branch}`;
    render();

  }catch(err){
    elStatus.textContent = `조회 실패: 네트워크/JSONP 오류 (${String(err.message||err)})`;
    lastData = null;
    renderEmpty();
  }
}

/* ✅ 0이어도 “틀(그리드/축)”은 항상 보이게 */
function svgLine({labels, series, height=190}){
  const w=680, h=height;
  const padL=34, padR=12, padT=12, padB=28;

  const n = Math.max(1, labels.length);
  const maxVal = Math.max(1, ...series.map(v=>Number(v||0))); // 0이어도 최소 1
  const xStep = (w - padL - padR) / Math.max(1, n-1);

  const x = i => padL + xStep*i;
  const y = v => padT + (h - padT - padB) * (1 - (Number(v||0) / maxVal));

  const path = series.map((v,i)=> `${i===0?'M':'L'} ${x(i).toFixed(2)} ${y(v).toFixed(2)}`).join(' ');

  const gridY = [0,0.25,0.5,0.75,1].map(t => padT + (h-padT-padB)*t);

  // 라벨은 너무 많으면 4개만
  const labelIdx = n<=6 ? [...Array(n).keys()] : [0, Math.floor((n-1)/3), Math.floor((n-1)*2/3), n-1];

  return `
  <svg viewBox="0 0 ${w} ${h}" width="100%" height="${h}" aria-hidden="true">
    ${gridY.map(gy=>`<line x1="${padL}" y1="${gy}" x2="${w-padR}" y2="${gy}" stroke="#e2e8f0" stroke-width="1"/>`).join('')}
    <line x1="${padL}" y1="${padT}" x2="${padL}" y2="${h-padB}" stroke="#cbd5e1" stroke-width="1"/>
    <line x1="${padL}" y1="${h-padB}" x2="${w-padR}" y2="${h-padB}" stroke="#cbd5e1" stroke-width="1"/>

    <path d="${path}" fill="none" stroke="#38a3ff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
    ${labelIdx.map(i=>`
      <text x="${x(i)}" y="${h-8}" text-anchor="middle" font-size="11" fill="#64748b" font-weight="900">
        ${labels[i] || ''}
      </text>
    `).join('')}
    <text x="${padL}" y="12" text-anchor="start" font-size="11" fill="#94a3b8" font-weight="900">max ${maxVal}</text>
  </svg>`;
}

function render(){
  if(!lastData){ renderEmpty(); return; }

  const mode = elTrend.value;     // daily / monthly
  const metric = elMetric.value;  // visits/call/...

  const src = (mode === 'monthly') ? lastData.monthly : lastData.daily;

  const labels = src.labels || [];
  const series = (src[metric] || []).map(v=>Number(v||0));

  elChart.innerHTML = svgLine({ labels, series, height:190 });

  const t = lastData.totals || {};
  const cards = [
    {title:'총 방문', value:t.visits},
    {title:'전화 클릭', value:t.call},
    {title:'예약 클릭', value:t.reserve},
    {title:'더 알아보기', value:t.more},
    {title:'카톡(준비중)', value:t.kakao_pending},
    {title:'클릭 합계', value:t.clicks},
    {title:'모바일', value:t.mobile},
    {title:'PC', value:t.pc},
  ];
  elCards.innerHTML = cards.map(c=>`
    <div class="card">
      <div class="t">${c.title}</div>
      <div class="v">${Number(c.value||0).toLocaleString()}</div>
    </div>
  `).join('');
}

function renderEmpty(){
  elChart.innerHTML = svgLine({ labels:['-'], series:[0], height:190 });
  elCards.innerHTML = `
    <div class="card"><div class="t">총 방문</div><div class="v">0</div></div>
    <div class="card"><div class="t">전화 클릭</div><div class="v">0</div></div>
    <div class="card"><div class="t">예약 클릭</div><div class="v">0</div></div>
    <div class="card"><div class="t">더 알아보기</div><div class="v">0</div></div>
  `;
}

/* ✅ 변경 즉시 자동 조회(디바운스) */
function autoFetch(){
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(fetchReport, 250);
}
['change','input'].forEach(ev=>{
  elBranch.addEventListener(ev, autoFetch);
  elTrend.addEventListener(ev, autoFetch);
  elMetric.addEventListener(ev, autoFetch);
  elStart.addEventListener(ev, autoFetch);
  elEnd.addEventListener(ev, autoFetch);
});

setDefaultRange();
fetchReport();
</script>
</body>
</html>
